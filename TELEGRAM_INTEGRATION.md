# üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram Web App

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–ß—Ç–æ —Ç–∞–∫–æ–µ Telegram Web App](#—á—Ç–æ-—Ç–∞–∫–æ–µ-telegram-web-app)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)
3. [–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è](#–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è-–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
4. [–†–µ–∂–∏–º—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞](#—Ä–µ–∂–∏–º—ã-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏-–∏-–ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)
5. [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –¥—ã—Ä—ã –∏ –∏—Ö –∑–∞–∫—Ä—ã—Ç–∏–µ](#–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å-–¥—ã—Ä—ã-–∏-–∏—Ö-–∑–∞–∫—Ä—ã—Ç–∏–µ)
6. [–í–æ–∑–º–æ–∂–Ω—ã–µ –±–∞–≥–∏](#–≤–æ–∑–º–æ–∂–Ω—ã–µ-–±–∞–≥–∏)
7. [–ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏](#–ø–ª–∞–Ω-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)

---

## –ß—Ç–æ —Ç–∞–∫–æ–µ Telegram Web App

Telegram Web App (TWA) ‚Äî —ç—Ç–æ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ Telegram. Telegram –ø–µ—Ä–µ–¥–∞—ë—Ç –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ —á–µ—Ä–µ–∑ JavaScript API.

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Telegram      ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   Web App       ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   Backend       ‚îÇ
‚îÇ   (–∫–ª–∏–µ–Ω—Ç)      ‚îÇ     ‚îÇ   (frontend)    ‚îÇ     ‚îÇ   (API)         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ                       ‚îÇ                       ‚îÇ
        ‚îÇ  initData             ‚îÇ  Verify initData      ‚îÇ
        ‚îÇ  (–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ         ‚îÇ  + Extract user       ‚îÇ
        ‚îÇ   –¥–∞–Ω–Ω—ã–µ —é–∑–µ—Ä–∞)       ‚îÇ                       ‚îÇ
        ‚ñº                       ‚ñº                       ‚ñº
   Telegram ID            JavaScript API          –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏
   Username               window.Telegram         BOT_TOKEN
   First/Last name        WebApp object           HMAC-SHA256
```

### –î–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ Telegram –ø–µ—Ä–µ–¥–∞—ë—Ç:

```javascript
// window.Telegram.WebApp.initDataUnsafe
{
    query_id: "AAHdF6...",
    user: {
        id: 123456789,              // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π Telegram ID
        first_name: "–í–∞–≥–∞–≥",
        last_name: "–ù–∞–ª–∞–Ω",
        username: "Mr_Aregak",      // @username (–º–æ–∂–µ—Ç –±—ã—Ç—å null)
        language_code: "ru",
        is_premium: true,           // Telegram Premium
        photo_url: "https://..."    // –ê–≤–∞—Ç–∞—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    },
    auth_date: 1234567890,
    hash: "abc123..."               // –ü–æ–¥–ø–∏—Å—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
}
```

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–±–µ–∑ Telegram):

```
Browser ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂ Frontend ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂ Backend ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂ MySQL
                   ‚îÇ
                   ‚îî‚îÄ‚îÄ sessionId (localStorage UUID)
```

### –ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (—Å Telegram):

```
Telegram App ‚îÄ‚îÄ‚ñ∂ Frontend ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂ Backend ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂ MySQL
                    ‚îÇ                 ‚îÇ
                    ‚îÇ  initData       ‚îÇ  Verify hash
                    ‚îÇ  (–æ—Ç Telegram)  ‚îÇ  (BOT_TOKEN)
                    ‚ñº                 ‚ñº
              Auto-login         –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è
              –ø–æ Telegram ID     –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
```

---

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ Frontend:

```javascript
// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω–æ –ª–∏ –≤ Telegram
function getTelegramUser() {
    // Telegram Web App API
    const tg = window.Telegram?.WebApp;
    
    if (!tg) {
        console.log('–ù–µ –≤ Telegram ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º');
        return null;
    }
    
    // –°–æ–æ–±—â–∞–µ–º Telegram, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ
    tg.ready();
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ù–ï –í–ï–†–ò–§–ò–¶–ò–†–û–í–ê–ù–ù–´–ï!)
    const user = tg.initDataUnsafe?.user;
    
    if (!user) {
        console.log('Telegram –Ω–µ –ø–µ—Ä–µ–¥–∞–ª –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return null;
    }
    
    return {
        telegramId: user.id,
        username: user.username || `user_${user.id}`,
        firstName: user.first_name,
        lastName: user.last_name,
        isPremium: user.is_premium || false,
        photoUrl: user.photo_url,
        // RAW –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        initData: tg.initData,  // ‚Üê –≠–¢–û –í–ê–ñ–ù–û –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏!
    };
}
```

### ‚ö†Ô∏è –í–ê–ñ–ù–û: –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞ Backend

**–î–∞–Ω–Ω—ã–µ –∏–∑ `initDataUnsafe` –º–æ–∂–Ω–æ –ø–æ–¥–¥–µ–ª–∞—Ç—å!**  
–í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π `initData` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.

```javascript
// Backend: routes/auth.js
const crypto = require('crypto');

function verifyTelegramWebAppData(initData, botToken) {
    // 1. –ü–∞—Ä—Å–∏–º initData (—ç—Ç–æ URL-encoded —Å—Ç—Ä–æ–∫–∞)
    const urlParams = new URLSearchParams(initData);
    const hash = urlParams.get('hash');
    urlParams.delete('hash');
    
    // 2. –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ —Å–æ–∑–¥–∞—ë–º —Å—Ç—Ä–æ–∫—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    const dataCheckString = Array.from(urlParams.entries())
        .sort(([a], [b]) => a.localeCompare(b))
        .map(([key, value]) => `${key}=${value}`)
        .join('\n');
    
    // 3. –°–æ–∑–¥–∞—ë–º —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –∏–∑ —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞
    const secretKey = crypto
        .createHmac('sha256', 'WebAppData')
        .update(botToken)
        .digest();
    
    // 4. –í—ã—á–∏—Å–ª—è–µ–º HMAC-SHA256
    const calculatedHash = crypto
        .createHmac('sha256', secretKey)
        .update(dataCheckString)
        .digest('hex');
    
    // 5. –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ö–µ—à–∏
    return calculatedHash === hash;
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
app.post('/api/auth/telegram', (req, res) => {
    const { initData } = req.body;
    
    if (!verifyTelegramWebAppData(initData, process.env.BOT_TOKEN)) {
        return res.status(401).json({ error: 'Invalid Telegram data' });
    }
    
    // –î–∞–Ω–Ω—ã–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã ‚Äî –º–æ–∂–Ω–æ –¥–æ–≤–µ—Ä—è—Ç—å!
    const urlParams = new URLSearchParams(initData);
    const user = JSON.parse(urlParams.get('user'));
    
    // –°–æ–∑–¥–∞—ë–º/–æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
    // ...
});
```

---

## –†–µ–∂–∏–º—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

### –ü—Ä–æ–±–ª–µ–º–∞:
- –í **development** –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ Telegram API (–æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –±—Ä–∞—É–∑–µ—Ä–µ)
- –í **production** –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏—Ö–æ–¥—è—Ç –æ—Ç Telegram

### –†–µ—à–µ–Ω–∏–µ: –†–µ–∂–∏–º –º–æ–∫–∞

```javascript
// frontend/js/telegram.js

const TelegramService = {
    isDev: window.location.hostname === 'localhost',
    
    // –ú–æ–∫-–¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
    mockUser: {
        id: 999999999,
        first_name: 'Dev',
        last_name: 'User',
        username: 'dev_user',
        language_code: 'ru',
    },
    
    getUser() {
        // –í development ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–∫
        if (this.isDev && !window.Telegram?.WebApp) {
            console.warn('üîß DEV MODE: –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–∫-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            return {
                telegramId: this.mockUser.id,
                username: this.mockUser.username,
                firstName: this.mockUser.first_name,
                initData: null,  // –ù–µ—Ç –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ dev
                isMock: true,
            };
        }
        
        // –í production ‚Äî —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç Telegram
        const tg = window.Telegram?.WebApp;
        if (!tg?.initDataUnsafe?.user) {
            return null;
        }
        
        tg.ready();
        const user = tg.initDataUnsafe.user;
        
        return {
            telegramId: user.id,
            username: user.username || `user_${user.id}`,
            firstName: user.first_name,
            initData: tg.initData,
            isMock: false,
        };
    },
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω–æ –ª–∏ –≤ Telegram
    isInTelegram() {
        return !!window.Telegram?.WebApp?.initData;
    },
};
```

### Backend: –†–∞–∑–Ω—ã–µ —Ä–µ–∂–∏–º—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

```javascript
// middleware/auth.js

async function authenticateUser(req, res, next) {
    const { initData, sessionId } = req.body;
    
    // –†–µ–∂–∏–º 1: Telegram Web App (production)
    if (initData) {
        if (!verifyTelegramWebAppData(initData, process.env.BOT_TOKEN)) {
            return res.status(401).json({ error: 'Invalid Telegram auth' });
        }
        
        const urlParams = new URLSearchParams(initData);
        const telegramUser = JSON.parse(urlParams.get('user'));
        
        // –ù–∞—Ö–æ–¥–∏–º –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ Telegram ID
        req.user = await findOrCreateUserByTelegram(telegramUser);
        return next();
    }
    
    // –†–µ–∂–∏–º 2: Session ID (development –∏–ª–∏ –Ω–µ-Telegram)
    if (sessionId) {
        // –í development —Ä–∞–∑—Ä–µ—à–∞–µ–º –±–µ–∑ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
        if (process.env.NODE_ENV === 'development') {
            req.user = await findOrCreateUserBySession(sessionId);
            return next();
        }
        
        // –í production session-only —Ä–µ–∂–∏–º –æ—Ç–∫–ª—é—á–µ–Ω
        return res.status(401).json({ error: 'Telegram auth required' });
    }
    
    return res.status(401).json({ error: 'No authentication provided' });
}
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

```env
# .env.development
NODE_ENV=development
ALLOW_SESSION_AUTH=true      # –†–∞–∑—Ä–µ—à–∏—Ç—å –≤—Ö–æ–¥ –±–µ–∑ Telegram
SKIP_TELEGRAM_VERIFY=true    # –ù–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–¥–ø–∏—Å—å (—Ç–æ–ª—å–∫–æ –¥–ª—è dev!)

# .env.production
NODE_ENV=production
BOT_TOKEN=123456:ABC-DEF...  # –¢–æ–∫–µ–Ω –æ—Ç @BotFather
ALLOW_SESSION_AUTH=false
SKIP_TELEGRAM_VERIFY=false
```

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –¥—ã—Ä—ã –∏ –∏—Ö –∑–∞–∫—Ä—ã—Ç–∏–µ

### üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –î–´–†–´

#### 1. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ Telegram –¥–∞–Ω–Ω—ã—Ö

**–ü—Ä–æ–±–ª–µ–º–∞:**
```javascript
// ‚ùå –û–ü–ê–°–ù–û: –î–∞–Ω–Ω—ã–µ –∏–∑ initDataUnsafe –º–æ–∂–Ω–æ –ø–æ–¥–¥–µ–ª–∞—Ç—å!
const user = window.Telegram.WebApp.initDataUnsafe.user;
await api.saveScore({ telegramId: user.id, score: 999999 });
```

**–ê—Ç–∞–∫–∞:**
```javascript
// –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –≤ DevTools:
window.Telegram = {
    WebApp: {
        initDataUnsafe: {
            user: { id: 1, username: 'admin' }  // –ü–æ–¥–¥–µ–ª–∫–∞!
        }
    }
};
```

**–†–µ—à–µ–Ω–∏–µ:**
- –í–°–ï–ì–î–ê –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `initData` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HMAC-SHA256 —Å BOT_TOKEN

---

#### 2. SQL Injection –≤ LIMIT/OFFSET (–ò–°–ü–†–ê–í–õ–ï–ù–û)

**–ë—ã–ª–æ:**
```javascript
// ‚ùå –û–ü–ê–°–ù–û: –°—Ç—Ä–æ–∫–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ LIMIT
const leaders = await db.query(
    `SELECT * FROM scores LIMIT ? OFFSET ?`,
    [limit, offset]  // –ú–æ–≥—É—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∫–∞–º–∏!
);
```

**–°—Ç–∞–ª–æ:**
```javascript
// ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û: –ß–∏—Å–ª–∞ –≤—Å—Ç—Ä–æ–µ–Ω—ã –≤ –∑–∞–ø—Ä–æ—Å
const limitNum = Number(limit);
const offsetNum = Number(offset);
const leaders = await db.query(
    `SELECT * FROM scores LIMIT ${limitNum} OFFSET ${offsetNum}`,
    []
);
```

---

#### 3. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ rate limiting –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –º–æ–∂–µ—Ç —Å–ø–∞–º–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏, –∑–∞–ø–æ–ª–Ω—è—è –ë–î.

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** ‚úÖ Rate limiting –µ—Å—Ç—å (10 req/min –Ω–∞ `/api/scores`)

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω–æ:**
```javascript
// –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –ø–æ Telegram ID, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –ø–æ IP
const userLimiter = rateLimit({
    keyGenerator: (req) => req.user?.telegramId || req.ip,
    max: 5,  // 5 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –º–∏–Ω—É—Ç—É –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
});
```

---

#### 4. –ê–Ω—Ç–∏—á–∏—Ç: –ù–µ—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å `{ score: 1000000, duration: 1000 }` ‚Äî –º–∏–ª–ª–∏–æ–Ω –æ—á–∫–æ–≤ –∑–∞ 1 —Å–µ–∫—É–Ω–¥—É.

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** ‚úÖ –ï—Å—Ç—å –±–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

**–ù—É–∂–Ω–æ —É—Å–∏–ª–∏—Ç—å:**
```javascript
// –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏:
const checks = {
    // –ú–∞–∫—Å–∏–º—É–º 100 –æ—á–∫–æ–≤ –∑–∞ –ø–æ–ø–∞–¥–∞–Ω–∏–µ * –º–∞–∫—Å –∫–æ–º–±–æ 10 = 1000 –æ—á–∫–æ–≤/–ø–æ–ø–∞–¥–∞–Ω–∏–µ
    maxScorePerHit: 1000,
    // –ú–∞–∫—Å–∏–º—É–º 1 –≤—ã—Å—Ç—Ä–µ–ª –≤ 350ms (SHOOT_COOLDOWN)
    maxShotsPerSecond: 3,
    // –¢–æ—á–Ω–æ—Å—Ç—å > 99% –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞
    suspiciousAccuracy: 0.99,
};

if (score > targetsHit * checks.maxScorePerHit) {
    return res.status(400).json({ error: 'Suspicious score' });
}
```

---

### üü° –°–†–ï–î–ù–ò–ï –î–´–†–´

#### 5. XSS —á–µ—Ä–µ–∑ username

**–ü—Ä–æ–±–ª–µ–º–∞:**
Telegram username –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã.

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** ‚úÖ –ï—Å—Ç—å `escapeHtml()` –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –Ω–∞ –±—ç–∫–µ–Ω–¥–µ:**
```javascript
// –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
const cleanUsername = username
    .replace(/[<>&"']/g, '')
    .substring(0, 32);
```

---

#### 6. –ù–µ—Ç HTTPS –≤ development

**–ü—Ä–æ–±–ª–µ–º–∞:**
Telegram Web App —Ç—Ä–µ–±—É–µ—Ç HTTPS (–∫—Ä–æ–º–µ localhost).

**–†–µ—à–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
```bash
# –ò—Å–ø–æ–ª—å–∑—É–π ngrok –¥–ª—è HTTPS —Ç—É–Ω–Ω–µ–ª—è
ngrok http 3001
# –ü–æ–ª—É—á–∏—à—å https://abc123.ngrok.io
```

---

#### 7. CORS —Å–ª–∏—à–∫–æ–º –æ—Ç–∫—Ä—ã—Ç—ã–π –≤ development

**–ü—Ä–æ–±–ª–µ–º–∞:**
```javascript
if (process.env.NODE_ENV === 'development') {
    res.header('Access-Control-Allow-Origin', '*');  // ‚ùå –í—Å—ë —Ä–∞–∑—Ä–µ—à–µ–Ω–æ
}
```

**–†–µ—à–µ–Ω–∏–µ:**
```javascript
const allowedOrigins = [
    'http://localhost:3001',
    'https://your-app.telegram.org',
];
```

---

### üü¢ –ú–ï–õ–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

#### 8. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ sensitive –¥–∞–Ω–Ω—ã—Ö

**–ü—Ä–æ–±–ª–µ–º–∞:**
```javascript
console.log('User data:', req.body);  // –ú–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–∫–µ–Ω—ã
```

**–†–µ—à–µ–Ω–∏–µ:**
```javascript
const sanitizeLog = (obj) => {
    const copy = { ...obj };
    delete copy.initData;
    delete copy.hash;
    return copy;
};
console.log('User data:', sanitizeLog(req.body));
```

---

## –í–æ–∑–º–æ–∂–Ω—ã–µ –±–∞–≥–∏

### üêõ –ë–∞–≥–∏ Frontend

| # | –ë–∞–≥ | –ü—Ä–∏—á–∏–Ω–∞ | –†–µ—à–µ–Ω–∏–µ |
|---|-----|---------|---------|
| 1 | –ü—Ä–∏—Ü–µ–ª –∏—Å—á–µ–∑–∞–µ—Ç –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ | `smoothedAimPosition` –æ—Ç—Å—Ç–∞—ë—Ç | –£–≤–µ–ª–∏—á–∏—Ç—å `sensitivity` |
| 2 | –î–≤–æ–π–Ω–æ–π –≤—ã—Å—Ç—Ä–µ–ª | `SHOOT_COOLDOWN` –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤ `checkJerk` | –ü—Ä–æ–≤–µ—Ä—è—Ç—å cooldown —Ä–∞–Ω—å—à–µ |
| 3 | –ò–≥—Ä–∞ –Ω–µ —Å—Ç–∞–≤–∏—Ç—Å—è –Ω–∞ –ø–∞—É–∑—É –ø—Ä–∏ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–∏ | –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ `visibilitychange` | –î–æ–±–∞–≤–∏—Ç—å `document.addEventListener('visibilitychange')` |
| 4 | –ü–∞–º—è—Ç—å —É—Ç–µ–∫–∞–µ—Ç –ø—Ä–∏ –¥–æ–ª–≥–æ–π –∏–≥—Ä–µ | –ß–∞—Å—Ç–∏—Ü—ã –Ω–µ –æ—á–∏—â–∞—é—Ç—Å—è –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ | –î–æ–±–∞–≤–∏—Ç—å `cleanup()` –≤ `exitGame` |
| 5 | –ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ | `srcObject.getTracks().stop()` –Ω–µ –≤—Å–µ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è | –í—ã–∑—ã–≤–∞—Ç—å –≤ `finally` –±–ª–æ–∫–µ |

### üêõ –ë–∞–≥–∏ Backend

| # | –ë–∞–≥ | –ü—Ä–∏—á–∏–Ω–∞ | –†–µ—à–µ–Ω–∏–µ |
|---|-----|---------|---------|
| 1 | `rank` ‚Äî reserved word | MySQL 8.0+ | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (—ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ) |
| 2 | –ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è | –ù–µ—Ç graceful shutdown –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–ª—É—á–∞—è—Ö | –î–æ–±–∞–≤–∏—Ç—å `process.on('beforeExit')` |
| 3 | –î—É–±–ª–∏–∫–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π | Race condition –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `INSERT ... ON DUPLICATE KEY UPDATE` |
| 4 | –¢–∞–π–º–∑–æ–Ω—ã –≤ –¥–∞—Ç–∞—Ö | MySQL –∏ Node.js –º–æ–≥—É—Ç –±—ã—Ç—å –≤ —Ä–∞–∑–Ω—ã—Ö TZ | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å UTC –≤–µ–∑–¥–µ |

### üêõ –ë–∞–≥–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

| # | –ë–∞–≥ | –ü—Ä–∏—á–∏–Ω–∞ | –†–µ—à–µ–Ω–∏–µ |
|---|-----|---------|---------|
| 1 | Telegram Web App –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è | CSP –±–ª–æ–∫–∏—Ä—É–µ—Ç | –î–æ–±–∞–≤–∏—Ç—å `https://telegram.org` –≤ CSP |
| 2 | –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç | Telegram –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `tg.BackButton` |
| 3 | –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç UI | –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `tg.MainButton` –≤–º–µ—Å—Ç–æ HTML –∫–Ω–æ–ø–æ–∫ |
| 4 | –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è | –ù–µ —á–∏—Ç–∞–µ–º `tg.colorScheme` | –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ç–µ–º—ã |

---

## –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (1-2 —á–∞—Å–∞)

- [ ] –°–æ–∑–¥–∞—Ç—å Telegram –±–æ—Ç–∞ —á–µ—Ä–µ–∑ @BotFather
- [ ] –ü–æ–ª—É—á–∏—Ç—å BOT_TOKEN
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Web App URL –≤ –±–æ—Ç–µ
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –≠—Ç–∞–ø 2: Backend (2-3 —á–∞—Å–∞)

- [ ] –°–æ–∑–¥–∞—Ç—å `/api/auth/telegram` endpoint
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `verifyTelegramWebAppData()`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å —Å—Ö–µ–º—É –ë–î (–¥–æ–±–∞–≤–∏—Ç—å `telegram_id` –∏–Ω–¥–µ–∫—Å)
- [ ] –î–æ–±–∞–≤–∏—Ç—å middleware –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- [ ] –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã

### –≠—Ç–∞–ø 3: Frontend (2-3 —á–∞—Å–∞)

- [ ] –ü–æ–¥–∫–ª—é—á–∏—Ç—å Telegram Web App SDK
- [ ] –°–æ–∑–¥–∞—Ç—å `TelegramService`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `SessionManager` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram
- [ ] –î–æ–±–∞–≤–∏—Ç—å UI –¥–ª—è Telegram (—Ç–µ–º–∞, –∫–Ω–æ–ø–∫–∏)
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ BotFather Test Environment

### –≠—Ç–∞–ø 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (1-2 —á–∞—Å–∞)

- [ ] –¢–µ—Å—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ (dev mode)
- [ ] –¢–µ—Å—Ç —á–µ—Ä–µ–∑ ngrok –≤ Telegram
- [ ] –¢–µ—Å—Ç –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –≠—Ç–∞–ø 5: –î–µ–ø–ª–æ–π

- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å HTTPS (Let's Encrypt)
- [ ] –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
- [ ] –û–±–Ω–æ–≤–∏—Ç—å Web App URL –≤ –±–æ—Ç–µ
- [ ] –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –±–æ—Ç–∞

---

## –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [Telegram Web Apps Documentation](https://core.telegram.org/bots/webapps)
- [Telegram Web App JS SDK](https://telegram.org/js/telegram-web-app.js)
- [BotFather](https://t.me/BotFather)
- [Test Environment](https://core.telegram.org/bots/webapps#testing-mini-apps)

---

*–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω: –î–µ–∫–∞–±—Ä—å 2024*  
*–ê–≤—Ç–æ—Ä: vahagn & co*

